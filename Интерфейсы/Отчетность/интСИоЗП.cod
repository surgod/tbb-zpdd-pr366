class inherited ћашина–еквизитов.Ѕазовые.инт«апись "";

inclass public

  func —в€занный ласс«аписей: class —»—2.Ѕазова€.Ѕазова€«апись;
    Result = ќтчетность.—»о«ѕ;
  end;

  func Create: ќтчетность.инт—»о«ѕ;
    Result = inherited Create;
    Result.SetRecord(ќтчетность.—»о«ѕ.Create);
  end;

  func ќткрытьѕо«аписи synonym OpenRecord (locRecord: ќтчетность.—»о«ѕ): ќтчетность.инт—»о«ѕ;
    Result = FindInterfaceByRecord(locRecord);
    if (Result = nil):
      Result = inherited Create;
      Result.SetRecord(locRecord);
    fi;
  end;

  func Ѕланк–едакторѕо”молчанию: class BlankForm;
    Result = ‘ормыќтчетов.‘онды.ред—»о«ѕ;
  end;

  func  артотекаѕо”молчанию: class CardForm;
    Result = ќтчетность.карт—»о«ѕ;
  end;


inobject public

  Record: ќтчетность.—»о«ѕ;
  var интЌастройка: Ќастройки.инт—»о«ѕ;


  proc ¬ыполнение–асчета;
    Post;
    –асчет–аздела_1;
    –асчет–аздела_2;
    –асчет–аздела_3;
    Post;
  end;

  proc ”далитьƒанные_–азделов (forRecord: ќтчетность.—»о«ѕ = nil);
    ”далитьƒанные_–аздел1(forRecord);
    ”далитьƒанные_–аздел2(forRecord);
    ”далитьƒанные_–аздел3(forRecord);
  end;

  proc ”далитьƒанные_–аздел1 (forRecord: ќтчетность.—»о«ѕ = nil);
    var Q: Query;
    Q = Query.Create([Ѕюджет_«ѕиƒƒ_ѕ–366.ќтчетность.—»о«ѕ_—«ѕ]);
    if (forRecord = nil):
      Q.Filter = 'ф—»о«ѕ=' + Str(Self.Record);
    else
      Q.Filter = 'ф—»о«ѕ=' + Str(forRecord);
    fi;
    Q.Select;
    —»—2.‘ункцииƒокумента.DeleteAllRecords(Q);
  end;

  proc ”далитьƒанные_–аздел2 (forRecord: ќтчетность.—»о«ѕ = nil);
    var Q: Query;
    Q = Query.Create([Ѕюджет_«ѕиƒƒ_ѕ–366.ќтчетность.—»о«ѕ_‘онд«ѕ]);
    if (forRecord = nil):
      Q.Filter = 'ф—»о«ѕ=' + Str(Self.Record);
    else
      Q.Filter = 'ф—»о«ѕ=' + Str(forRecord);
    fi;
    Q.Select;
    —»—2.‘ункцииƒокумента.DeleteAllRecords(Q);
  end;

  proc ”далитьƒанные_–аздел3 (forRecord: ќтчетность.—»о«ѕ = nil);
    var Q: Query;
    Q = Query.Create([Ѕюджет_«ѕиƒƒ_ѕ–366.ќтчетность.—»о«ѕ_—«ѕ–ук]);
    if (forRecord = nil):
      Q.Filter = 'ф—»о«ѕ=' + Str(Self.Record);
    else
      Q.Filter = 'ф—»о«ѕ=' + Str(forRecord);
    fi;
    Q.Select;
    —»—2.‘ункцииƒокумента.DeleteAllRecords(Q);
  end;

  proc –асчет–аздела_1;
    var m, mm, s, ss, n: integer;
    var локѕериод: “ЅЅ_Ѕазовый.—правочники.ѕериоды–асчета;
    var м—отрудник: Ѕазовый.ƒанные.—убъект[];
    var мЌазначение: Ѕюджет_ѕерсонал.јтрибуты—отрудника.Ќазначение[];
    var инт—«ѕ :ќтчетность.инт—«ѕ;
    ”далитьƒанные_–аздел1;
    интЌастройка = Ќастройки.инт—»о«ѕ.OpenForSubject(Record.Ќаше”чреждение);
    mm = Record.ѕериод_—«ѕ.Count;
    for m = 1 .. mm do
      локѕериод = Record.ѕериод_—«ѕ[m];
      м—отрудник = ѕолучить—писок—отрудников(локѕериод);
      ss = LengthOfArray(м—отрудник);
      for s = 1 .. ss do
        Hint('–асчет мес€ца ' + Str(m) + ' из ' + Str(mm) + '...',  s, ss);
        мЌазначение = Ѕюджет_ѕерсонал.Ѕиблио.јктуальныеЌазначени€(м—отрудник[s], nil, Ѕюджет_ѕерсонал. онстанты.‘ормаЌазначени€ќсн, локѕериод.ƒатаЌачала, локѕериод.ƒатаќкончани€);
        инт—«ѕ = nil;
        for n = 1 .. LengthOfArray(мЌазначение) do
          инт—«ѕ = ќтчетность.инт—«ѕ.CreateByOwner(Record, локѕериод, мЌазначение[n]);
        od;
        if (инт—«ѕ <> nil):
          инт—«ѕ.Calc;
        fi;
      od;
    od;
  end;

  func ѕолучить—писок—отрудников (локѕериод: “ЅЅ_Ѕазовый.—правочники.ѕериоды–асчета): Ѕазовый.ƒанные.—убъект[];
    var aFlt: string[];
    with Query.Create([Ѕюджет_ѕерсонал.јтрибуты—отрудника.ѕериод–аботы]) do
      aFlt[1] = '—отрудник.Ќаше”чреждение=' + Str(Record.Ќаше”чреждение);
      aFlt[2] = ' од√руппыЌачислений="' + Ѕюджет_ѕерсонал. онстанты√руппЌачислений.√руппаЌачислений«арплата + '"';
      aFlt[3] = “ЅЅ_Ѕазовый.‘ильтры.‘ильтрѕоƒатам(локѕериод.ƒатаЌачала,локѕериод.ƒатаќкончани€);
      Filter = “ЅЅ_Ѕазовый.‘ильтры.—ложить—троки‘ильтраѕо»(aFlt);
      Order = '—отрудник.‘излицо.»м€';
      Select;
      while not Eof do
        —»—2.‘ункции.AddInArray(Result, Current.—отрудник, true);
        Next;
      od;
    end;
  end;

  proc –асчет–аздела_2;
    var y, yy: integer;
    var инт‘онд«ѕ :ќтчетность.инт‘онд«ѕ;
    ”далитьƒанные_–аздел2;
    интЌастройка = Ќастройки.инт—»о«ѕ.OpenForSubject(Record.Ќаше”чреждение);
    yy = Record.ѕериод_‘онд«ѕ.Count;
    for y = 1 .. yy do
      Hint('–асчет раздела 2 за ' + Record.ѕериод_‘онд«ѕ[y].»м€);
      инт‘онд«ѕ = ќтчетность.инт‘онд«ѕ.CreateByOwner(Record, Record.ѕериод_‘онд«ѕ[y]);
      if (инт‘онд«ѕ <> nil):
        инт‘онд«ѕ.Calc;
      fi;
    od;
  end;

  proc –асчет–аздела_3;
    ”далитьƒанные_–аздел3;
    интЌастройка = Ќастройки.инт—»о«ѕ.OpenForSubject(Record.Ќаше”чреждение);
  end;


inobject private

  --@doc Ёта процедура наследует ћ–; Ќа нее зав€зано изменение пол€ Record во всех методах интерфейса;
  proc SetRecord (locRecord: ќтчетность.—»о«ѕ);
    Inherited SetRecord(locRecord);
    интЌастройка = Ќастройки.инт—»о«ѕ.OpenForSubject(Record.Ќаше”чреждение);
  end;

end