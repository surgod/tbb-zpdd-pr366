class inherited ћашина–еквизитов.Ѕазовые.инт«апись "";

inclass public

  func —в€занный ласс«аписей: class —»—2.Ѕазова€.Ѕазова€«апись;
    Result = ќтчетность.—»о«ѕ_‘онд«ѕ;
  end;

  func Create: ќтчетность.инт‘онд«ѕ;
    Result = inherited Create;
    Result.SetRecord(ќтчетность.—»о«ѕ_‘онд«ѕ.Create);
  end;

  func CreateByOwner(locOwnerRecord: ќтчетность.—»о«ѕ;
                     локѕериод: “ЅЅ_Ѕазовый.—правочники.ѕериоды–асчета;
                     withMsg: logical = false): ќтчетность.инт‘онд«ѕ;
    var locMsg: string;
    var aFlt: string[];
    var locFlt: string;
    var locRecord: ќтчетность.—»о«ѕ_‘онд«ѕ;
    -- —оздание новой записи
    -- ѕоиск существующей записи
    aFlt[1] = 'ф—»о«ѕ=' + Str(locOwnerRecord);
    aFlt[2] = 'ќтчетныйѕериод=' + Str(локѕериод);
    locFlt = “ЅЅ_Ѕазовый.‘ильтры.—ложить—троки‘ильтраѕо»(aFlt);
    locRecord = —»—2.‘ункцииƒокумента.QueryRecord(ќтчетность.—»о«ѕ_‘онд«ѕ, locFlt);
    if (locRecord <> nil): -- запись существует
      if withMsg:
        locMsg = 'ќтчетный период ' + локѕериод.»м€ + ' уже добавлен в раздел 2 отчета. ѕовторное добавление не допускаетс€.';
        “ЅЅ_Ѕазовый.Console.Message(locMsg);
      fi;
    else
      Result = Self.Create;
      Result.Record.ф—»о«ѕ = locOwnerRecord;
      Result.Record.ќтчетныйѕериод = локѕериод;
      Result.Record.Post;
      if withMsg:
        locMsg = '—оздана запись в разделе 2 : ' + локѕериод.»м€ + '.';
          “ЅЅ_Ѕазовый.Console.Message(locMsg);
      fi;
      —»—2.‘ункцииƒокумента.RecordPostIfNeed(Result.Record);
    fi;
  end;

  func ќткрытьѕо«аписи synonym OpenRecord (locRecord: ќтчетность.—»о«ѕ_‘онд«ѕ): ќтчетность.инт‘онд«ѕ;
    Result = FindInterfaceByRecord(locRecord);
    if (Result = nil):
      Result = inherited Create;
      Result.SetRecord(locRecord);
    fi;
  end;

  func Ѕланк–едакторѕо”молчанию: class BlankForm;
    Result = ‘ормыќтчетов.‘онды.ред‘онд«ѕ;
  end;

  func  артотекаѕо”молчанию: class CardForm;
  end;

inobject public

  var Record: ќтчетность.—»о«ѕ_‘онд«ѕ;
  var интЌастройка: Ќастройки.инт—»о«ѕ;
  var ¬идыЌачислений¬–асчете: Ѕюджет_«ѕиƒƒ.—правочники.¬идыЌачислений[];
  var ”казныеЌазначени€ :integer[];--Ѕюджет_ѕерсонал.јтрибуты—отрудника.Ќазначение[];

  proc Calc;
    var лок¬идыЅюджета: Ѕюджет_«ѕиƒƒ.—правочники.¬идыЅюджета[];
    ѕолучитьЌастройку;
    лок¬идыЅюджета = —»—2.‘ункцииƒокумента.ReadStructField(интЌастройка.Record.Ѕюджеты«ѕ.‘едеральный) as Ѕюджет_«ѕиƒƒ.—правочники.¬идыЅюджета[];
    Record.–асхќбщ‘ед = ѕолучить—уммуЌачислений_¬сего(лок¬идыЅюджета);
    Record.–асх ат‘ед = ѕолучить—уммуЌачислений_”казных(лок¬идыЅюджета);
    лок¬идыЅюджета = —»—2.‘ункцииƒокумента.ReadStructField(интЌастройка.Record.Ѕюджеты«ѕ.—убъекта–‘) as Ѕюджет_«ѕиƒƒ.—правочники.¬идыЅюджета[];
    Record.–асхќбщ—уб = ѕолучить—уммуЌачислений_¬сего(лок¬идыЅюджета);
    Record.–асх ат—уб = ѕолучить—уммуЌачислений_”казных(лок¬идыЅюджета);
    лок¬идыЅюджета = —»—2.‘ункцииƒокумента.ReadStructField(интЌастройка.Record.Ѕюджеты«ѕ.ћуниципальный) as Ѕюджет_«ѕиƒƒ.—правочники.¬идыЅюджета[];
    Record.–асхќбщћун = ѕолучить—уммуЌачислений_¬сего(лок¬идыЅюджета);
    Record.–асх атћун = ѕолучить—уммуЌачислений_”казных(лок¬идыЅюджета);
    лок¬идыЅюджета = —»—2.‘ункцииƒокумента.ReadStructField(интЌастройка.Record.Ѕюджеты«ѕ.ќћ—) as Ѕюджет_«ѕиƒƒ.—правочники.¬идыЅюджета[];
    Record.–асхќбщќћ— = ѕолучить—уммуЌачислений_¬сего(лок¬идыЅюджета);
    Record.–асх атќћ— = ѕолучить—уммуЌачислений_”казных(лок¬идыЅюджета);
    лок¬идыЅюджета = —»—2.‘ункцииƒокумента.ReadStructField(интЌастройка.Record.Ѕюджеты«ѕ.»нойЅюджет) as Ѕюджет_«ѕиƒƒ.—правочники.¬идыЅюджета[];
    Record.–асхќбщ»ные = ѕолучить—уммуЌачислений_¬сего(лок¬идыЅюджета);
    Record.–асх ат»ные = ѕолучить—уммуЌачислений_”казных(лок¬идыЅюджета);
    ѕересчет»тогов;
  end;

  proc ѕересчет»тогов;
    Record.–асхќбщ¬сего = Record.–асхќбщ‘ед + Record.–асхќбщ—уб + Record.–асхќбщћун + Record.–асхќбщќћ— + Record.–асхќбщ»ные;
    Record.–асх ат¬сего = Record.–асх ат‘ед + Record.–асх ат—уб + Record.–асх атћун + Record.–асх атќћ— + Record.–асх ат»ные;
  end;

inobject private

  --@doc Ёта процедура наследует ћ–; Ќа нее зав€зано изменение пол€ Record во всех методах интерфейса;
  proc SetRecord (locRecord: ќтчетность.—»о«ѕ_‘онд«ѕ);
    Inherited SetRecord(locRecord);
    ѕолучитьЌастройку;
  end;

  proc ѕолучитьЌастройку; -- при невозможности определить наше учреждение поле интЌастройка деинициализируетс€
    if (Record.ф—»о«ѕ <> nil):
      интЌастройка = Ќастройки.инт—»о«ѕ.OpenForSubject(Record.ф—»о«ѕ.Ќаше”чреждение);
      ¬идыЌачислений¬–асчете = интЌастройка.ѕолучить¬идыЌачислений¬–асчете;
      ѕолучить”казныеЌазначени€;
    else
      интЌастройка = nil;
      ¬идыЌачислений¬–асчете = nil;
      ”казныеЌазначени€ = nil;
    fi;
  end;

  proc ѕолучить”казныеЌазначени€;
    var QResult: variant[2];
    var м¬сеЌазначени€: Ѕюджет_ѕерсонал.јтрибуты—отрудника.Ќазначение[];
    var м”казныеЌазначени€: Ѕюджет_ѕерсонал.јтрибуты—отрудника.Ќазначение[];
    var aFlt: string[];
    var локЎифр”Ќ,локЎифрЌ: string;
    var мЎифр”Ќ: string[];
    var i: integer;
    ”казныеЌазначени€ = nil;
    with Query.Create([Ѕюджет_«ѕиƒƒ.–асчетныеќперации.Ќачисление]) do
      aFlt = nil;
      aFlt[1] = '–асчет.√руппаЌачислений<>"' + Ѕюджет_«п»ƒƒ. онстанты.√руппаќперацийƒовольствие + '"';
      Filter = “ЅЅ_Ѕазовый.‘ильтры.—ложить—троки‘ильтраѕо»(aFlt);
      QResult = CalcAggregates('GroupBy(Ќазначение)') as variant[2];
      м¬сеЌазначени€ = QResult[1] as Ѕюджет_ѕерсонал.јтрибуты—отрудника.Ќазначение[];
    end;
    --
    with Query.Create([Ѕюджет_ѕерсонал.—правочники.Ўтатное–асписание]) do
      aFlt = nil;
      aFlt[1] = 'Ў–=' + Str(интЌастройка.Record.Ўтатное–асписание);
      aFlt[2] = 'isGroup=0';
      aFlt[3] = '  ѕ<>nil';
      aFlt[4] = '  ѕ<>"600"';
      Filter = “ЅЅ_Ѕазовый.‘ильтры.—ложить—троки‘ильтраѕо»(aFlt);
      Select;
      while not Eof do
        локЎифр”Ќ = Str((Current as Ѕюджет_ѕерсонал.—правочники.Ўтатное–асписание).ѕодразделение.DocID) +
                    '#' +
                    Str((Current as Ѕюджет_ѕерсонал.—правочники.Ўтатное–асписание).ƒолжность.DocID);
        —»—2.‘ункции.AddInArray(мЎифр”Ќ, локЎифр”Ќ, true);
        Next;
      od;
    end;
    --
    for i = 1 .. LengthOfArray(м¬сеЌазначени€) do
      локЎифрЌ = Str(м¬сеЌазначени€[i].ѕодразделение.DocID) + '#' + Str(м¬сеЌазначени€[i].ƒолжность.DocID);
      if (локЎифрЌ in мЎифр”Ќ):
        —»—2.‘ункции.AddInArray(м”казныеЌазначени€, м¬сеЌазначени€[i]);
      fi;
    od;
    for i = 1 .. LengthOfArray(м”казныеЌазначени€) do
      —»—2.‘ункции.AddInArray(”казныеЌазначени€, м”казныеЌазначени€[i].DocId);
    od;
  end;

  func ѕолучить—уммуЌачислений_¬сего(лок¬идыЅюджета: Ѕюджет_«ѕиƒƒ.—правочники.¬идыЅюджета[]): numeric;
    var aFlt: string[];
    with Query.Create([Ѕюджет_«ѕиƒƒ.–асчетныеќперации.Ќачисление]) do
      aFlt[1] = '–асчет.Ќаше”чреждение=' + Str(Record.ф—»о«ѕ.Ќаше”чреждение);
      aFlt[2] = 'SubStr(–асчет.”четныйѕериод. од,1,4)="' + Str(Record.ќтчетныйѕериод. од) + '"';
      aFlt[3] = '—умма ”чету<>0';
      aFlt[4] = '–асчет.“ип–асчета<>' + Str(Ѕюджет_«ѕиƒƒ. онстанты.“ип–асчетајванс);
      aFlt[5] = '–асчет.ѕодшивка.«авершен';
      aFlt[6] = '¬идЌачислени€ in ' + Str(¬идыЌачислений¬–асчете);
      aFlt[7] = 'Ѕюджет in ' + Str(лок¬идыЅюджета);
      Filter = “ЅЅ_Ѕазовый.‘ильтры.—ложить—троки‘ильтраѕо»(aFlt);
      Return CalcAggregates('Sum(—умма ”чету)') as numeric;
    end;
  end;

  func ѕолучить—уммуЌачислений_”казных(лок¬идыЅюджета: Ѕюджет_«ѕиƒƒ.—правочники.¬идыЅюджета[]): numeric;
    var aFlt: string[];
    with Query.Create([Ѕюджет_«ѕиƒƒ.–асчетныеќперации.Ќачисление]) do
      aFlt[1] = '–асчет.Ќаше”чреждение=' + Str(Record.ф—»о«ѕ.Ќаше”чреждение);
      aFlt[2] = 'SubStr(–асчет.”четныйѕериод. од,1,4)="' + Str(Record.ќтчетныйѕериод. од) + '"';
      aFlt[3] = '—умма ”чету<>0';
      aFlt[4] = '–асчет.“ип–асчета<>' + Str(Ѕюджет_«ѕиƒƒ. онстанты.“ип–асчетајванс);
      aFlt[5] = '–асчет.ѕодшивка.«авершен';
      aFlt[6] = '¬идЌачислени€ in ' + Str(¬идыЌачислений¬–асчете);
      aFlt[7] = 'Ѕюджет in ' + Str(лок¬идыЅюджета);
      aFlt[8] = 'Ќазначение.DocId in ' + Str(”казныеЌазначени€);
      Filter = “ЅЅ_Ѕазовый.‘ильтры.—ложить—троки‘ильтраѕо»(aFlt);
      Return CalcAggregates('Sum(—умма ”чету)') as numeric;
    end;
  end;


end