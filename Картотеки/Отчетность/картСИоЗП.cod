Class inherited ТББ_Базовый.Базовые.картДокумент "Формы СИоЗП";

Import ТББ_Базовый Classes Переменные;

--{{2_ Свойства

inclass private
  var КлассИнтерфейса: class МашинаРеквизитов.Базовые.интЗапись = Отчетность.интСИоЗП;
  stored var ГодСв: integer;
  var ПолеСтолбцаНаше: String:= 'НашеУчреждение.Имя';
  var ИдентифицироватьНашеПриСоздании: logical = true;

inobject private
  var ГодСвОбъекта: integer;

--}}

--2_ Конструкторы, визуализаторы0. --

inclass public

--2_ Обработчики событий шаблона0. --

inobject private

  proc шаблон_ПриОткрытии2_ 0.(Create:2_ 0.Logical);
    var locCell: TemplateCell;
    var локКодПериода: string;
    var локОтчетныйПериод: ТББ_Базовый.Справочники.ПериодыРасчета;
    if (Mon(today) = 1):     локКодПериода = Str((Year(today) - 1), '0000') + '4.12';
    elsif (Mon(today) = 2):  локКодПериода = Str((Year(today)), '0000') + '1.1.01';
    elsif (Mon(today) = 3):  локКодПериода = Str((Year(today)), '0000') + '1.1.02';
    elsif (Mon(today) = 4):  локКодПериода = Str((Year(today)), '0000') + '1.1.03';
    elsif (Mon(today) = 5):  локКодПериода = Str((Year(today)), '0000') + '1.2.04';
    elsif (Mon(today) = 6):  локКодПериода = Str((Year(today)), '0000') + '1.2.05';
    elsif (Mon(today) = 7):  локКодПериода = Str((Year(today)), '0000') + '1.2.06';
    elsif (Mon(today) = 8):  локКодПериода = Str((Year(today)), '0000') + '1.3.07';
    elsif (Mon(today) = 9):  локКодПериода = Str((Year(today)), '0000') + '1.3.08';
    elsif (Mon(today) = 10): локКодПериода = Str((Year(today)), '0000') + '1.3.09';
    elsif (Mon(today) = 11): локКодПериода = Str((Year(today)), '0000') + '1.4.10';
    elsif (Mon(today) = 12): локКодПериода = Str((Year(today)), '0000') + '1.4.11';
    fi;
    локОтчетныйПериод = Бюджет_Персонал.Календарь.ПериодПоКоду(локКодПериода);
    ПараметрыНовойЗаписи[1] = ['ОтчетныйПериод', локОтчетныйПериод];
    inherited шаблон_ПриОткрытии(Create);
    locCell = Template.FrameByName['фреймФильтр'].CellByField['ГодСвОбъекта'];
    locCell.List.Clear;
    with Query.Create([ТББ_Базовый.Справочники.ПериодыРасчета]) do
      Filter = 'Match(Код,"????")';
      Order = 'Код';
      Select;
      while (not Eof) do
        locCell.List.Add(Current.Код + '|' + Current.Код); Next;
      od;
    end;
  end;

-- 2_Обработчики событий картотеки0. --

  func картотека_ПриСозданииЗаписи (var Record: Отчетность.СИоЗП): Logical;
    Result = inherited картотека_ПриСозданииЗаписи(Record);
    Result = (Record.НашеУчреждение <> nil);
    if Result:
      Record.ИНН = Record.НашеУчреждение.ИНН;
      Record.КПП = Record.НашеУчреждение.КодПричины;
    fi;
  end;

  func картотека_ПередИзменением(Action :Cardfile.ModifyActions; aRecord :Record; aGroup :Record; var AskConfirm :Logical) :Logical;
    var i, ii: integer;
    if (Action = Cardfile.DeleteRecord): --это удаление
      if (aRecord <> nil): -- изменяется одна запись
        --Отчетность.инт6НДФЛ2.УдалитьЗаписиРазделов(aRecord);
      else -- изменяется группа записей -- (aRecord=nil)
        ii = Self.Cardfile.SelectedCount;
        for i = 1 .. ii do
          Hint('[' + Str(i) + '/' + Str(ii) + '] : Удаление сопряженных записей...');
          --Отчетность.инт6НДФЛ2.УдалитьЗаписиРазделов(Self.Cardfile.Selected[i]);
        od;
      fi;
    fi;
    Result = inherited картотека_ПередИзменением(Action, aRecord, aGroup, AskConfirm);
  end;

--2_ Обработчики событий клеток шаблона0. --

  proc ПолеШаблона_ПриВыходе2_ 0.(Cell: TemplateCell; Index: Integer);
    if (Cell.Contents = 'НашеУчреждение'):
      ОбновитьФильтр;
      Template.CellByField['ГодСвОбъекта'].SetFocus;
    elsif (Cell.Contents = 'ГодСвОбъекта'):
      ГодСв = ГодСвОбъекта;
      ОбновитьФильтр;
    fi;
  end;

  func ПолеШаблона_ПриВыводе2_ 0.(Cell: TemplateCell; Value: Variant; Action: Template.OutputTypes; var Format: String): Variant;
    if (Cell.Contents = 'НашеУчреждение'):
      Result = inherited ПолеШаблона_ПриВыводе(Cell, Value, Action, Format);
    elsif (Cell.Contents = 'ГодСвОбъекта'):
      if Cell.Value = nil:
        Result = '<i+><cf:Gray>Все';
      else
        Result = ГодСвОбъекта;
      fi;
    fi;
  end;

--2_ Обработчики событий прочих объектов шаблона0. --

--2_ Обработчики столбцов (полей) картотеки0. --

  func картПоле_ПриВыводе (Column: CardfileColumn; Rec: Бюджет_ЗПиДД_ПР366.Отчетность.СИоЗП; Action: Template.OutputTypes; var Format: String): Variant;
    var ii: integer;
    if (Column.FieldName = 'ОтчетныйПериод1'):
      ii = Rec.Период_СЗП.Count;
      if (ii = 1):
        Return Rec.Период_СЗП[1].Имя;
      elsif (ii = 2):
        Return Rec.Период_СЗП[1].Имя + ', ' + Rec.Период_СЗП[2].Имя;
      elsif (ii > 2):
        Return Rec.Период_СЗП[1].Имя + ' - ' + Rec.Период_СЗП[ii].Имя;
      fi;
    elsif (Column.FieldName = 'ОтчетныйПериод2'):
      ii = Rec.Период_ФондЗП.Count;
      if (ii = 1):
        Return Rec.Период_ФондЗП[1].Имя;
      elsif (ii = 2):
        Return Rec.Период_ФондЗП[1].Имя + ', ' + Rec.Период_ФондЗП[2].Имя;
      elsif (ii > 2):
        Return Rec.Период_ФондЗП[1].Имя + ' - ' + Rec.Период_ФондЗП[ii].Имя;
      fi;
    elsif (Column.FieldName = 'ОтчетныйПериод3'):
      ii = Rec.Период_СЗПРук.Count;
      if (ii = 1):
        Return Rec.Период_СЗПРук[1].Имя;
      elsif (ii = 2):
        Return Rec.Период_СЗПРук[1].Имя + ', ' + Rec.Период_СЗПРук[2].Имя;
      elsif (ii > 2):
        Return Rec.Период_СЗПРук[1].Имя + ' - ' + Rec.Период_СЗПРук[ii].Имя;
      fi;
    fi;
  end;


--2_ Дополнительные команды0. --

--2_ Вспомогательные методы0. --

  --@doc Ф-я перекрывает СИС2, устанавливает фильтр на кртотеку через контролы шаблона
  func ПолучитьФильтрКартотеки2_ 0.(var locTreeFilter: string = nil): string;
    var StrArray: string[];
    ГодСвОбъекта = ГодСв;
    StrArray[1] = inherited ПолучитьФильтрКартотеки(locTreeFilter);
    StrArray[2] = if(ГодСвОбъекта > 0, 'ОтчетГод=' + Str(ГодСвОбъекта), nil);
    Result = СИС2.СтроковыеФункции.СложитьСтрокиФильтраПоИ(StrArray);
  end;

end
